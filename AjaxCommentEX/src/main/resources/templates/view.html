<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">

    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <title>instagram</title>
    <link rel="stylesheet" href="/css/reset.css">
    <link rel="stylesheet" href="/css/common.css">
<!--     <link rel="stylesheet" href="/css/style.css"> -->
    <link rel="stylesheet" href="/css/detail-page.css">

    <style>
        #main_container {
            /*height: 6000px;*/
        }
        
        .com_modify_box {
        	position: abso
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
    
</head>
<body>

<section id="container">
 	<!-- 헤더 -->
   	<div th:replace="~{/fragments/header.html :: fragment-header}"></div>
    
    <!-- 사이드메뉴바 nav-->
    <div th:replace="~{/fragments/nav.html :: fragment-nav}"></div>

	<!-- 메인 -->
    <div id="main_container">

        <section class="b_inner">

            <div class="contents_box">

                <article class="contents_detail">

                    <div class="img_section">
                        <div class="trans_inner">
                            <div><img src="imgs/img_section/img03.jpg" alt=""></div>
                        </div>
                    </div>

                    <div class="detail--right_box">
                        <header class="top">
                            <div class="user_container">
                                <div class="profile_img">
                                    <img src="imgs/thumb.jpeg" alt="">
                                </div>
                                <div class="user_name">
                                    <div class="nick_name">KindTiger</div>
                                    <div class="country">Seoul, South Korea</div>
                                </div>
                            </div>
                            <div class="sprite_more_icon" data-name="more">
                                <ul class="more_detail">
                                    <li>팔로우</li>
                                    <li>수정</li>
                                    <li>삭제</li>
                                </ul>
                            </div>
                        </header>
						
						
						
                        <section class="scroll_section" >
                        
                            <div class="admin_container">
                                <div class="admin"><img src="imgs/thumb.jpeg" alt="user"></div>
                                <div class="comment">
                                    <span class="user_id">Kindtiger</span>강아지가 많이 힘든가보다ㅜㅜㅜㅜㅜ조금만힘내
                                    <div class="time">2시간</div>
                                </div>
                            </div>
                            
                          	<div id="commBox">
							 	<div class="user_container-detail" th:each="comm,i : ${list}" >
	                                <div class="user"><img src="imgs/thumb02.jpg" alt="user"></div>
	                               		 <div class="comment">
		                                    <span class="user_id">[[${comm.mem_id}]]</span>
		                                    <span class="comm_text">[[${comm.com_text}]]</span>
		                                    
		                                    <div class="com_modify_box">
		                                    	<form style="display:flex">
		                                    		<input type="text" name="com_text" style="display:block" th:value="${comm.com_text}">
		                                    		<input type="button" value="댓글 수정" class="comm_modify_btn">
		                                    	</form>
		                                    </div>
		                                    
		                                    <!-- 댓글 crud버튼 박스 -->
		                                    <div class="commDetailBox" style="display:flex; color:#999;">
												<span>일전</span>
												<span class="deleteBox"><a th:href="@{/deleteComment(com_id=${comm.com_id})}" style="text-decoration:none; color:#999;">삭제</a></span>
												<span><a th:value="${#ids.next('list')}" th:id="${#ids.seq('subComBtnId_')}"> 답글 달기 </a></span>
												<span class="modify_comment" ><a>수정</a></span>
												<!-- 댓글 작성자 id와 로그인 세션값 id 비교해서 일치하는 경우에 수정 버튼 출력 th:if 사용-->
											</div>
		                                    
		                                    <!-- 대댓글 입력 폼 -->
		                                    <div class="subComBox">
		                                    	<form th:id="${#ids.seq('subComBoxId_')}" style="display:none;">
		                                    		<input type="hidden" id="com_id" th:value="${comm.com_id}">
													<input type="text" name="subcom_text" id="subcom_text" class="subcom_text" placeholder="대댓글 작성" value="" >
													<input type="button" value="대댓글 작성">														
												</form>
		                                    </div>
		                                   
		                                    	<div class="subComShowHere"></div>
		                                    	
		                                    <div class="icon_wrap">
		                                        <div class="more_trigger">
		                                            <div class="sprite_more_icon"></div>
		                                        </div>
		                                        <div>
		                                            <div class="sprite_small_heart_icon_outline"></div>
		                                        </div>
		                                    </div>
		                                </div>
		                            </div> 
		                           </div>
	                        </section>
                        	
                        
                        
                        <div class="bottom_icons">
                            <div class="left_icons">
                                <div class="heart_btn">
                                    <div class="sprite_heart_icon_outline" data-name="heartbeat"></div>
                                </div>
                                <div>
                                    <div class="sprite_bubble_icon"></div>
                                </div>
                                <div>
                                    <div class="sprite_share_icon" data-name="share"></div>
                                </div>
                            </div>

                            <div class="right_icon">
                                <div class="sprite_bookmark_outline" data-name="book-mark"></div>
                            </div>
                        </div>

                        <div class="count_likes">
                            좋아요
                            <span class="count">2,351</span>
                            개
                        </div>
                        <div class="timer">2시간</div>

                        <div class="commit_field">
                        
                        	<input type="hidden" id = "mem_id" name="mem_id" value="testmember1">
                        	<input type="hidden" id = "post_id" name="post_id" value="2">
                            <input type="text" id = "com_text" name="com_text" placeholder="댓글달기..">
	
							<button id="select_btn"> 출력 </button>
							<button id="text_btn"> ajax테스트</button>
							
                            <div class="upload_btn" onclick="insertComment()">게시</div>
                            <div class="comment_box">
							</div>
                        </div>
                    </div>
                </article>
            </div>
        </section>
    </div>
</section>

<script>

	 // 대댓글창 출력 함수
	$(document).ready(function() {
		$(".deleteBox").next().click(function() {
			//let a = $(this).next();
			
			let a = $(this).parent().next().children();
			console.log(a)
			
			
			if( a.is(":visible")) {
				a.css('display','none');
			} else {
				a.css('display','block');
			}
		})
	});

	// 댓글 인서트 메소드
	function insertComment() {
			var params = {
					"post_id" : $("#post_id").val(),
					"com_text" : $('#com_text').val()
				};
			
			$.ajax({
				url : "/insertComment",
				type : "POST",
				data : params
			}).done(function (fragment) {
				$('#com_text').val("")
				// 댓글 작성 후 작성란 공백처리
				 $("#commBox").append(fragment);
			})
		}
	
	// 대댓글 인서트 메소드
	$(document).ready(function() {
		$(".subcom_text").next().click(function() {
			let com_id = $(this).prev().prev().val();	
			let subcom_text = $(this).prev().val()
			// 대댓글 작성 시 자신이 종속되어 있는 댓글의 번호를 참조해야 하기 때문에
			// 댓글 작성 버튼을 기준으로 prev와 next를 이용해서 com_id 및 대댓글 작성란을 찾게끔 구현했음.
		
			var params = {
					"com_id" : com_id,
					"subcom_text" : subcom_text
				};
		
			$.ajax({
				url : "/insertSubComment",
				type : "POST",
				data : params
			}).done(function (fragment) {
				 $(".subcom_text").val("")
				 // 대댓글 작성 후 작성란 공백처리
				 $("#subComShowHere").append(fragment);
			})
			
		})
	 })
	 
	  // 댓글 삭제 메소드
		function deleteComment() {
			var com_id = $("#com_id").val();
			
			console.log("com_id : " + com_id);
			
			$.ajax({
				url : "/deleteComment",
				type : "POST",
				data : com_id
			}).done(function (fragment) {
				 $("#commBox").replaceWith(fragment);
			})
		}
		
	/* function updateComment() {
	    var commentBean = {
	        email : $("#commentEmail").val(),
	        content : $("#commentContent").val(),
	        post_num : $("#commentPostNum").val()
	    };
	    $.ajax({
	        url: "/view",
	        type: "POST",
	        data: commentBean,
	    })
	    .done(function (fragment) {
	        $('#commentTable').replaceWith(fragment);
	    });
	} */
		
	
	document.querySelector("#text_btn").addEventListener("click", function() {
		const a = "<div>테스트</div>";
		
		$.ajax({
			type : "POST",
			url : "/ajaxTest",
			dataType : "text",
			data : "a", 
			success : function(res) {
				$(".comment_box").append(data)
				console.log("성공");
			},
			error : function(request,status,error) {
				console.log("통신 실패" + "\n" + 
				"code : " + request.status + "\n" + 
				"message : " + request.responseText + "\n" + 
				"error" + error
				)
			}
		})
	})
	
	
	function ajax(){
		  $.ajax({
		    url: "/test",
		    type: "POST",
		    success : function(data){
		      //alert(data)
		     $(".comment_box").append(data)
		    },
		    error : function(){
		      alert("에러")		
		    }
		  });
		}
	
	/* 
		해결해야 할 문제
		1. 댓글 답글달기 누르면 해당 댓글의 input text창 보이게
			구현 완료
		2. 댓글 작성하면 바로 출력되게 (ajax append나 html 이용해서)
			
		3. 댓글 수정기능(대댓글 기능과 비슷하게);
		4. 방금 전, 몇분 전, 몇시간 전, 몇일 전, 몇주 전 등 시간 출력하기
			절반 성공. 값 넘기면 해결 될수도?
			거의 성공. 메인에서 상세로 넘어갈때 게시글 번호 넘겨서 
		5. 로그인 세션값이 존재하면 댓글 창 출력되게
			
			
		- 좋아요
		1. 누르면 인서트, 빨간 하트로 시간차 줘서 바뀌게
		2. 
	*/
	
</script>
</body>
 